name: Build
on: [push]
jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: "16"

      - run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc
          yarn install
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Code format check
        run: yarn prettier

      - run: yarn workspace cartesi-subgraph prepare:goerli
        env:
          PROJECT_ID: ${{ secrets.PROJECT_ID }}

      - run: mv ./packages/pos-subgraph/subgraph.goerli.yaml ./packages/pos-subgraph/subgraph.yaml
      - run: yarn workspace cartesi-subgraph codegen
      - run: yarn workspace cartesi-subgraph build
      - run: yarn workspace cartesi-subgraph test
